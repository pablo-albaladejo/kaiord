# Testing

- Vitest; coverage ≥ 80% (mappers/converters ≥ 90%)
- **Co-located tests**: `file.ts` → `file.test.ts` (same directory)
- **All fixtures**: `src/tests/fixtures/` directory (faker + rosie factories, binary files)
- **Test helpers**: `src/tests/helpers/` directory (mock utilities, test utils)
- **Unit** (pure mappers/validators)
- **Golden** (KRD snapshots, normalized TCX/PWX fragments)
- **Round‑trip** (FIT/TCX/PWX ↔ KRD) with tolerances (±1s, ±1W, ±1bpm, ±1rpm)
- **CLI smoke** (tiny anonymized fixtures < 20KB)

## What NOT to Test

- **DO NOT test types** - TypeScript validates types at compile time, no runtime tests needed
- **DO NOT test fixtures** - Fixtures are test utilities, not production code
- **DO NOT test type definitions** - If it compiles, the types are correct
- **DO NOT test that objects match their type** - This is what TypeScript does

## What TO Test

- **Business logic** - Converters, mappers, validators, transformations
- **Edge cases** - Boundary conditions, empty inputs, invalid data
- **Integration** - How components work together
- **Round-trip conversions** - Data integrity through format conversions
- **Error handling** - How code responds to failures

## Test Assertions

- **Use `toStrictEqual()` for objects** - Validates complete object structure
- **Use fixtures with `.build()`** - Generate realistic test data
- **Include all fields in assertions** - When using `toStrictEqual()`, specify all fields (use `obj.field` for generated values)
- **One `expect` per object** - Validate entire objects, not individual properties

```typescript
// ✅ Good - Complete object validation
const metadata = buildKRDMetadata.build({
  created: "2025-01-15T10:30:00Z",
  sport: "running",
});

expect(metadata).toStrictEqual({
  created: "2025-01-15T10:30:00Z",
  manufacturer: metadata.manufacturer, // Generated by fixture
  product: metadata.product,
  serialNumber: metadata.serialNumber,
  sport: "running",
  subSport: metadata.subSport,
});

// ❌ Bad - Multiple expects for same object
expect(metadata.created).toBe("2025-01-15T10:30:00Z");
expect(metadata.sport).toBe("running");

// ❌ Bad - Testing types (unnecessary)
const metadata: KRDMetadata = buildKRDMetadata.build();
expect(metadata).toBeDefined(); // TypeScript already validates this
```
