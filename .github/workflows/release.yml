name: Release

on:
  release:
    types: [published]

permissions:
  contents: write
  packages: write
  id-token: write # Required for npm provenance

jobs:
  publish:
    name: Publish to npm
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          registry-url: "https://registry.npmjs.org"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm -r build

      - name: Parse release tag
        id: parse-tag
        run: |
          TAG="${{ github.event.release.tag_name }}"
          echo "Parsing release tag: $TAG"

          # Use the parse-release-tag.sh script
          if ! OUTPUT=$(bash scripts/parse-release-tag.sh "$TAG"); then
            echo "âŒ Failed to parse release tag"
            exit 1
          fi

          # Extract outputs from script
          PACKAGE_NAME=$(echo "$OUTPUT" | grep "PACKAGE_NAME=" | cut -d'=' -f2)
          VERSION=$(echo "$OUTPUT" | grep "VERSION=" | cut -d'=' -f2)

          # Set GitHub Actions outputs
          echo "package-name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          echo "âœ… Parsed tag successfully"
          echo "  Package: $PACKAGE_NAME"
          echo "  Version: $VERSION"

      - name: Validate package
        id: validate-package
        run: |
          PACKAGE_NAME="${{ steps.parse-tag.outputs.package-name }}"
          VERSION="${{ steps.parse-tag.outputs.version }}"

          echo "Validating package: $PACKAGE_NAME@$VERSION"

          # Use the validate-package.sh script
          if ! OUTPUT=$(bash scripts/validate-package.sh "$PACKAGE_NAME" "$VERSION"); then
            echo "âŒ Package validation failed"
            exit 1
          fi

          # Extract package directory from script output
          PACKAGE_DIR=$(echo "$OUTPUT" | grep "PACKAGE_DIR=" | cut -d'=' -f2)

          # Set GitHub Actions output
          echo "package-dir=$PACKAGE_DIR" >> $GITHUB_OUTPUT

          echo "âœ… Package validated successfully"
          echo "  Package: $PACKAGE_NAME"
          echo "  Version: $VERSION"
          echo "  Directory: $PACKAGE_DIR"

      - name: Publish package
        id: publish-package
        run: |
          PACKAGE_NAME="${{ steps.parse-tag.outputs.package-name }}"
          VERSION="${{ steps.parse-tag.outputs.version }}"

          echo "Publishing $PACKAGE_NAME@$VERSION with retry logic..."

          # Retry function with exponential backoff (5s, 10s, 20s)
          retry_publish() {
            local max_attempts=3
            local attempt=1
            local delay=5
            
            while [ $attempt -le $max_attempts ]; do
              echo "Attempt $attempt of $max_attempts..."
              
              if pnpm --filter "$PACKAGE_NAME" publish --access public --no-git-checks --provenance; then
                echo "âœ… Successfully published $PACKAGE_NAME@$VERSION"
                return 0
              fi
              
              if [ $attempt -lt $max_attempts ]; then
                echo "âš ï¸  Publish failed, retrying in ${delay}s..."
                sleep $delay
                delay=$((delay * 2))  # Exponential backoff
              fi
              
              attempt=$((attempt + 1))
            done
            
            echo "âŒ Failed to publish $PACKAGE_NAME@$VERSION after $max_attempts attempts"
            return 1
          }

          retry_publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        continue-on-error: true

      - name: Create failure issue and notify maintainers
        if: steps.publish-package.outcome == 'failure'
        uses: actions/github-script@v8
        with:
          script: |
            const packageName = '${{ steps.parse-tag.outputs.package-name }}';
            const version = '${{ steps.parse-tag.outputs.version }}';
            const tagName = '${{ github.event.release.tag_name }}';

            const issueBody = `## ðŸš¨ Release Publishing Failed

            **Package:** ${packageName}@${version}
            **Tag:** ${tagName}
            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            **Triggered by:** @${{ github.actor }}
            **Timestamp:** ${new Date().toISOString()}

            ### Failed Package

            - âŒ ${packageName}@${version}

            ### Error Details

            **${packageName}:** Failed after 3 retry attempts with exponential backoff

            View complete logs: [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### Common Causes

            1. **Invalid NPM_TOKEN:** Token expired or lacks publish permissions
            2. **Network Issues:** npm registry temporarily unavailable
            3. **Version Conflict:** Version already published to npm
            4. **Package Configuration:** Invalid package.json or missing files
            5. **Build Artifacts:** Build step failed or produced invalid output

            ### Remediation Steps

            #### 1. Verify NPM Token
            \`\`\`bash
            # Check token validity (requires npm CLI)
            npm whoami --registry https://registry.npmjs.org
            \`\`\`

            #### 2. Check npm Registry Status
            - Visit: https://status.npmjs.org/
            - Verify no ongoing incidents

            #### 3. Verify Package Version
            \`\`\`bash
            # Check current published version
            npm view ${packageName} version

            # Check local version
            node -p "require('./${{ steps.validate-package.outputs.package-dir }}/package.json').version"
            \`\`\`

            #### 4. Manual Publishing (if needed)
            \`\`\`bash
            # Authenticate with npm
            npm login

            # Build packages
            pnpm -r build

            # Publish manually
            pnpm --filter ${packageName} publish --access public
            \`\`\`

            #### 5. Re-run Workflow
            - Fix any identified issues
            - Re-run the [failed workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - Or create a new release

            ### Priority

            ðŸ”´ **CRITICAL:** Release is blocked - immediate action required

            ### Notification

            @${{ github.repository_owner }} - Release publishing failed for ${packageName}@${version}, please investigate.

            ### Next Steps

            - [ ] Review workflow logs for detailed error messages
            - [ ] Verify NPM_TOKEN secret configuration
            - [ ] Check npm registry status
            - [ ] Verify package version and build artifacts
            - [ ] Fix identified issues
            - [ ] Re-run workflow or manually publish
            - [ ] Verify package is available on npm
            - [ ] Close this issue once resolved

            ---

            **Note:** This issue was automatically created by the release workflow.
            **Maintainers will be notified via GitHub notifications.**`;

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Release failed: ${packageName}@${version} (${tagName})`,
              body: issueBody,
              labels: ['release', 'bug', 'automated', 'priority-critical'],
              assignees: [context.repo.owner]
            });

            // Add a comment to notify maintainers explicitly
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.data.number,
              body: `ðŸ”” **Notification:** @${context.repo.owner}\n\nThe release workflow has failed for **${packageName}@${version}** (tag: ${tagName}). Please review the issue details above and take immediate action.`
            });

      - name: Fail workflow if publishing failed
        if: steps.publish-package.outcome == 'failure'
        run: |
          PACKAGE_NAME="${{ steps.parse-tag.outputs.package-name }}"
          VERSION="${{ steps.parse-tag.outputs.version }}"
          TAG_NAME="${{ github.event.release.tag_name }}"

          echo "âŒ Release publishing failed"
          echo ""
          echo "Package: $PACKAGE_NAME"
          echo "Version: $VERSION"
          echo "Tag: $TAG_NAME"
          echo ""
          echo "The package $PACKAGE_NAME@$VERSION failed to publish after multiple retry attempts."
          echo "An issue has been created with detailed information and remediation steps."
          echo ""
          echo "Please check the workflow logs and the created GitHub issue for more details."
          exit 1

      - name: Summary
        run: |
          PACKAGE_NAME="${{ steps.parse-tag.outputs.package-name }}"
          VERSION="${{ steps.parse-tag.outputs.version }}"

          echo "## ðŸ“¦ Published Package" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… $PACKAGE_NAME@$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**npm package:** [$PACKAGE_NAME@$VERSION](https://www.npmjs.com/package/$PACKAGE_NAME/v/$VERSION)" >> $GITHUB_STEP_SUMMARY
