name: Changeset Bot

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - main

permissions:
  pull-requests: write

jobs:
  changeset-check:
    name: Check for Changeset
    runs-on: ubuntu-latest
    # Skip for automated PRs and version commits
    if: |
      !contains(github.head_ref, 'changeset-release') &&
      !contains(github.event.pull_request.title, 'Version Packages')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check for changesets
        id: check
        run: |
          # Get list of changeset files (excluding README.md and config.json)
          CHANGESETS=$(find .changeset -name "*.md" ! -name "README.md" 2>/dev/null | wc -l | tr -d ' ')

          echo "Found $CHANGESETS changeset file(s)"
          echo "count=$CHANGESETS" >> $GITHUB_OUTPUT

          # Check if any publishable package files changed
          # All packages except workout-spa-editor (private) are published to npm
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)

          PUBLISHABLE="packages/core packages/cli packages/fit packages/tcx packages/zwo packages/garmin packages/garmin-connect packages/mcp packages/ai"
          NEEDS_CHANGESET=false

          for pkg in $PUBLISHABLE; do
            if echo "$CHANGED_FILES" | grep -q "^${pkg}/"; then
              echo "Changed: $pkg"
              NEEDS_CHANGESET=true
            fi
          done

          echo "needs-changeset=$NEEDS_CHANGESET" >> $GITHUB_OUTPUT

      - name: Comment on PR (missing changeset)
        if: steps.check.outputs.count == '0' && steps.check.outputs.needs-changeset == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ðŸ“¦ Changeset Required

            This PR modifies publishable packages but doesn't include a changeset.

            **To add a changeset:**

            \`\`\`bash
            pnpm exec changeset
            \`\`\`

            This will prompt you to:
            1. Select affected packages (@kaiord/core, @kaiord/cli, @kaiord/fit, @kaiord/tcx, @kaiord/zwo, @kaiord/garmin, @kaiord/garmin-connect, @kaiord/mcp)
            2. Choose bump type (patch/minor/major)
            3. Write a summary of your changes

            **Skip if:**
            - Changes are internal only (tests, docs, refactoring without API changes)
            - This is a chore/maintenance PR

            ---
            *This comment was generated automatically by the Changeset Bot.*`;

            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('Changeset Required')
            );

            if (!botComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Fail if changeset is missing
        if: steps.check.outputs.count == '0' && steps.check.outputs.needs-changeset == 'true'
        run: |
          echo "::error::Missing changeset. Run 'pnpm exec changeset' and commit the generated file."
          exit 1

      - name: Comment on PR (changeset found)
        if: steps.check.outputs.count != '0' && steps.check.outputs.needs-changeset == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // Remove any previous "missing changeset" comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('Changeset Required')
            );

            if (botComment) {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id
              });
            }
