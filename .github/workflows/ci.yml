name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      core-changed: ${{ steps.changes.outputs.core-changed }}
      frontend-changed: ${{ steps.changes.outputs.frontend-changed }}
      should-test: ${{ steps.changes.outputs.should-test }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Detect changed files
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files_yaml: |
            core:
              - 'packages/core/**'
            frontend:
              - 'packages/workout-spa-editor/**'
            root_deps:
              - 'package.json'
              - 'pnpm-lock.yaml'
            docs:
              - '**.md'
              - 'docs/**'
              - '.github/**/*.md'

      - name: Analyze changes
        id: changes
        run: |
          # Intelligent change detection for monorepo optimization
          # This step determines which packages need testing based on changed files

          # Core package changes
          if [[ "${{ steps.changed-files.outputs.core_any_changed }}" == "true" ]] || \
             [[ "${{ steps.changed-files.outputs.root_deps_any_changed }}" == "true" ]]; then
            echo "core-changed=true" >> $GITHUB_OUTPUT
          else
            echo "core-changed=false" >> $GITHUB_OUTPUT
          fi

          # Frontend package changes
          if [[ "${{ steps.changed-files.outputs.frontend_any_changed }}" == "true" ]] || \
             [[ "${{ steps.changed-files.outputs.root_deps_any_changed }}" == "true" ]]; then
            echo "frontend-changed=true" >> $GITHUB_OUTPUT
          else
            echo "frontend-changed=false" >> $GITHUB_OUTPUT
          fi

          # Performance optimization: Skip all tests if only documentation changed
          # This reduces CI time from ~5 minutes to ~30 seconds for docs-only PRs
          if [[ "${{ steps.changed-files.outputs.docs_any_changed }}" == "true" ]] && \
             [[ "${{ steps.changed-files.outputs.core_any_changed }}" == "false" ]] && \
             [[ "${{ steps.changed-files.outputs.frontend_any_changed }}" == "false" ]] && \
             [[ "${{ steps.changed-files.outputs.root_deps_any_changed }}" == "false" ]]; then
            echo "should-test=false" >> $GITHUB_OUTPUT
          else
            echo "should-test=true" >> $GITHUB_OUTPUT
          fi

      - name: Display change detection results
        run: |
          echo "Core changed: ${{ steps.changes.outputs.core-changed }}"
          echo "Frontend changed: ${{ steps.changes.outputs.frontend-changed }}"
          echo "Should test: ${{ steps.changes.outputs.should-test }}"

  lint:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.should-test == 'true'
    strategy:
      fail-fast: false
      matrix:
        node-version: ["20.x", "22.x"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup pnpm with caching
        uses: ./.github/actions/setup-pnpm
        with:
          node-version: ${{ matrix.node-version }}

      - name: Run linting (ESLint + Prettier)
        run: pnpm lint

  typecheck:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.should-test == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup pnpm with caching
        uses: ./.github/actions/setup-pnpm

      - name: Run TypeScript type checking
        run: pnpm -r exec tsc --noEmit

  test:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.should-test == 'true'
    strategy:
      fail-fast: false
      matrix:
        node-version: ["20.x", "22.x"]
        package: ["core"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup pnpm with caching
        uses: ./.github/actions/setup-pnpm
        with:
          node-version: ${{ matrix.node-version }}

      - name: Run tests with coverage
        run: pnpm --filter @kaiord/core test:coverage

      - name: Upload coverage to Codecov
        # Only upload coverage from Node 20.x to avoid duplicate reports
        if: matrix.node-version == '20.x'
        uses: codecov/codecov-action@v4
        with:
          files: ./packages/core/coverage/coverage-final.json
          flags: core
          name: core-${{ matrix.node-version }}
          fail_ci_if_error: false

      - name: Check coverage threshold
        run: node .github/scripts/check-coverage.js ./packages/core/coverage/coverage-final.json

      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-core-${{ matrix.node-version }}
          path: ./packages/core/coverage/
          retention-days: 30

  build:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.should-test == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup pnpm with caching
        uses: ./.github/actions/setup-pnpm

      - name: Build core package
        run: pnpm --filter @kaiord/core build

      - name: Verify build outputs
        run: |
          if [ ! -d "packages/core/dist" ]; then
            echo "‚ùå @kaiord/core build output not found"
            exit 1
          fi
          echo "‚úÖ @kaiord/core build verified"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            packages/*/dist/
            packages/*/package.json
          retention-days: 7

  test-frontend:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.should-test == 'true'
    strategy:
      fail-fast: false
      matrix:
        node-version: ["20.x", "22.x"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup pnpm with caching
        uses: ./.github/actions/setup-pnpm
        with:
          node-version: ${{ matrix.node-version }}

      - name: Build core package (dependency)
        run: pnpm --filter @kaiord/core build

      - name: Run frontend tests with coverage
        run: pnpm --filter @kaiord/workout-spa-editor test -- --coverage

      - name: Check coverage threshold (70%)
        run: node .github/scripts/check-coverage.js ./packages/workout-spa-editor/coverage/coverage-final.json 70

      - name: Upload coverage to Codecov
        if: matrix.node-version == '20.x'
        uses: codecov/codecov-action@v4
        with:
          files: ./packages/workout-spa-editor/coverage/coverage-final.json
          flags: frontend
          name: frontend-${{ matrix.node-version }}
          fail_ci_if_error: false

      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-frontend-${{ matrix.node-version }}
          path: ./packages/workout-spa-editor/coverage/
          retention-days: 30

  round-trip:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.should-test == 'true'
    strategy:
      fail-fast: false
      matrix:
        package: ["core"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup pnpm with caching
        uses: ./.github/actions/setup-pnpm

      - name: Run round-trip tests
        run: |
          echo "Running round-trip tests for @kaiord/core..."
          echo "Tolerance validation: ¬±1s (time), ¬±1W (power), ¬±1bpm (heart rate), ¬±1rpm (cadence)"

          # Run tests matching round-trip pattern
          pnpm --filter @kaiord/core exec vitest --run --reporter=verbose \
            --testNamePattern="round.?trip|Round.?trip|tolerance|Tolerance" 2>&1 | tee round-trip-output.txt

          # Check if any tests failed
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "‚ùå Round-trip tests failed"
            echo ""
            echo "Tolerance violations detected. The following metrics exceeded acceptable tolerances:"
            echo "  - Time: ¬±1 second"
            echo "  - Power: ¬±1 watt or ¬±1% FTP"
            echo "  - Heart Rate: ¬±1 bpm"
            echo "  - Cadence: ¬±1 rpm"
            echo ""
            echo "Please review the test output above for specific violations."
            exit 1
          fi

          echo "‚úÖ All round-trip tests passed with acceptable tolerances"

      - name: Upload round-trip test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: round-trip-results-core
          path: round-trip-output.txt
          retention-days: 30

  # Summary jobs for branch protection
  # These jobs have fixed names that match branch protection requirements
  lint-summary:
    name: lint
    runs-on: ubuntu-latest
    needs: lint
    if: always()
    steps:
      - name: Check lint status
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] && [ "${{ needs.lint.result }}" != "skipped" ]; then
            echo "Lint failed"
            exit 1
          fi
          echo "Lint passed or skipped"

  test-summary:
    name: test
    runs-on: ubuntu-latest
    needs: test
    if: always()
    steps:
      - name: Check test status
        run: |
          if [ "${{ needs.test.result }}" != "success" ] && [ "${{ needs.test.result }}" != "skipped" ]; then
            echo "Tests failed"
            exit 1
          fi
          echo "Tests passed or skipped"

  round-trip-summary:
    name: round-trip
    runs-on: ubuntu-latest
    needs: round-trip
    if: always()
    steps:
      - name: Check round-trip status
        run: |
          if [ "${{ needs.round-trip.result }}" != "success" ] && [ "${{ needs.round-trip.result }}" != "skipped" ]; then
            echo "Round-trip tests failed"
            exit 1
          fi
          echo "Round-trip tests passed or skipped"

  test-frontend-summary:
    name: test-frontend
    runs-on: ubuntu-latest
    needs: test-frontend
    if: always()
    steps:
      - name: Check frontend test status
        run: |
          if [ "${{ needs.test-frontend.result }}" != "success" ] && [ "${{ needs.test-frontend.result }}" != "skipped" ]; then
            echo "Frontend tests failed"
            exit 1
          fi
          echo "Frontend tests passed or skipped"

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs:
      [detect-changes, lint, typecheck, test, test-frontend, build, round-trip]
    if: |
      always() &&
      github.ref == 'refs/heads/main' &&
      (needs.lint.result == 'failure' ||
       needs.typecheck.result == 'failure' ||
       needs.test.result == 'failure' ||
       needs.test-frontend.result == 'failure' ||
       needs.build.result == 'failure' ||
       needs.round-trip.result == 'failure')
    permissions:
      issues: write
    steps:
      - name: Create failure issue
        uses: actions/github-script@v8
        with:
          script: |
            const failedJobs = [];

            if ('${{ needs.lint.result }}' === 'failure') {
              failedJobs.push('Lint');
            }
            if ('${{ needs.typecheck.result }}' === 'failure') {
              failedJobs.push('Type Check');
            }
            if ('${{ needs.test.result }}' === 'failure') {
              failedJobs.push('Tests (Core)');
            }
            if ('${{ needs.test-frontend.result }}' === 'failure') {
              failedJobs.push('Tests (Frontend)');
            }
            if ('${{ needs.build.result }}' === 'failure') {
              failedJobs.push('Build');
            }
            if ('${{ needs.round-trip.result }}' === 'failure') {
              failedJobs.push('Round-trip Tests');
            }

            const title = `üö® CI Failure on main branch`;

            const body = `## CI Workflow Failed on Main Branch

            **Commit:** ${context.sha.substring(0, 7)}
            **Author:** @${context.actor}
            **Workflow Run:** ${context.payload.repository.html_url}/actions/runs/${context.runId}
            **Triggered:** ${new Date().toISOString()}

            ### Failed Jobs

            ${failedJobs.map(job => `- ‚ùå ${job}`).join('\n')}

            ### Workflow Details

            - **Branch:** main
            - **Commit Message:** ${context.payload.head_commit?.message || 'N/A'}
            - **Commit URL:** ${context.payload.repository.html_url}/commit/${context.sha}

            ### Error Logs

            View the complete error logs in the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId}).

            ### Remediation Steps

            1. **Review the workflow logs** to identify the root cause
            2. **Check recent commits** that may have introduced the failure
            3. **Run tests locally** to reproduce the issue:
               \`\`\`bash
               pnpm install
               pnpm lint
               pnpm exec tsc --noEmit
               pnpm test
               pnpm -r build
               \`\`\`
            4. **Fix the issue** and push a new commit
            5. **Verify the fix** by checking the next workflow run
            6. **Close this issue** once the workflow passes

            ### Priority

            üî¥ **HIGH:** Main branch is broken - immediate action required

            ### Next Steps

            - [ ] Investigate root cause
            - [ ] Fix the failing jobs
            - [ ] Verify fix with local tests
            - [ ] Push fix to main
            - [ ] Confirm workflow passes
            - [ ] Close this issue

            ---

            **Note:** This issue was automatically created by the CI workflow.`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['ci', 'bug', 'automated', 'priority-high']
            });
