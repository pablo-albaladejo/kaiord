name: Auto Changeset

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-changeset:
    name: Generate Changeset from Commits
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate changeset from conventional commits
        id: generate
        run: |
          set -e

          # Get all commits in this PR
          if ! git fetch origin main --depth=1; then
            echo "Failed to fetch origin/main. Ensure the branch exists."
            echo "has-changeset=false" >> $GITHUB_OUTPUT
            echo "changeset-created=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          COMMITS=$(git log origin/main..HEAD --pretty=format:"%s" --no-merges || echo "")

          echo "Analyzing commits:"
          echo "$COMMITS"

          # Detect affected packages and bump types
          CORE_BUMP=""
          CLI_BUMP=""
          CORE_CHANGES=""
          CLI_CHANGES=""

          while IFS= read -r commit; do
            # Parse conventional commit format
            if [[ $commit =~ ^(feat|fix|perf|refactor|docs|style|test|chore|build|ci)(\(([^\)]+)\))?:(.+)$ ]]; then
              TYPE="${BASH_REMATCH[1]}"
              SCOPE="${BASH_REMATCH[3]}"
              MESSAGE="${BASH_REMATCH[4]}"
              
              # Validate message doesn't contain problematic characters for YAML
              if [[ $MESSAGE =~ ([\"\$\`\!]) ]]; then
                echo "‚ö†Ô∏è Warning: Skipping commit with problematic characters: $commit"
                continue
              fi
              
              # Determine bump type
              BUMP_TYPE="patch"
              if [[ $TYPE == "feat" ]]; then
                BUMP_TYPE="minor"
              fi
              if [[ $commit == *"BREAKING CHANGE"* ]] || [[ $commit == *"!"* ]]; then
                BUMP_TYPE="major"
              fi
              
              # Determine affected packages
              if [[ $SCOPE == "core" ]] || [[ $commit == *"packages/core"* ]]; then
                if [[ -z $CORE_BUMP ]] || [[ $BUMP_TYPE == "major" ]] || [[ $BUMP_TYPE == "minor" && $CORE_BUMP == "patch" ]]; then
                  CORE_BUMP=$BUMP_TYPE
                fi
                CORE_CHANGES="${CORE_CHANGES}- ${MESSAGE}\n"
              fi
              
              if [[ $SCOPE == "cli" ]] || [[ $commit == *"packages/cli"* ]]; then
                if [[ -z $CLI_BUMP ]] || [[ $BUMP_TYPE == "major" ]] || [[ $BUMP_TYPE == "minor" && $CLI_BUMP == "patch" ]]; then
                  CLI_BUMP=$BUMP_TYPE
                fi
                CLI_CHANGES="${CLI_CHANGES}- ${MESSAGE}\n"
              fi
              
              # If no scope specified, affect all packages
              if [[ -z $SCOPE ]]; then
                if [[ -z $CORE_BUMP ]] || [[ $BUMP_TYPE == "major" ]] || [[ $BUMP_TYPE == "minor" && $CORE_BUMP == "patch" ]]; then
                  CORE_BUMP=$BUMP_TYPE
                fi
                if [[ -z $CLI_BUMP ]] || [[ $BUMP_TYPE == "major" ]] || [[ $BUMP_TYPE == "minor" && $CLI_BUMP == "patch" ]]; then
                  CLI_BUMP=$BUMP_TYPE
                fi
                CORE_CHANGES="${CORE_CHANGES}- ${MESSAGE}\n"
                CLI_CHANGES="${CLI_CHANGES}- ${MESSAGE}\n"
              fi
            fi
          done <<< "$COMMITS"

          # Check if changeset already exists
          if [ -n "$(ls -A .changeset/*.md 2>/dev/null | grep -v README)" ]; then
            echo "Changeset already exists, skipping generation"
            echo "has-changeset=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Generate changeset if changes detected
          if [[ -n $CORE_BUMP ]] || [[ -n $CLI_BUMP ]]; then
            CHANGESET_FILE=".changeset/auto-$(date +%s).md"
            
            echo "---" > "$CHANGESET_FILE"
            
            if [[ -n $CORE_BUMP ]]; then
              echo "\"@kaiord/core\": \"$CORE_BUMP\"" >> "$CHANGESET_FILE"
            fi
            
            if [[ -n $CLI_BUMP ]]; then
              echo "\"@kaiord/cli\": \"$CLI_BUMP\"" >> "$CHANGESET_FILE"
            fi
            
            echo "---" >> "$CHANGESET_FILE"
            echo "" >> "$CHANGESET_FILE"
            
            if [[ -n $CORE_CHANGES ]]; then
              echo "### @kaiord/core" >> "$CHANGESET_FILE"
              echo "" >> "$CHANGESET_FILE"
              printf "%b\n" "$CORE_CHANGES" >> "$CHANGESET_FILE"
            fi
            
            if [[ -n $CLI_CHANGES ]]; then
              echo "### @kaiord/cli" >> "$CHANGESET_FILE"
              echo "" >> "$CHANGESET_FILE"
              printf "%b\n" "$CLI_CHANGES" >> "$CHANGESET_FILE"
            fi
            
            echo "Generated changeset:"
            cat $CHANGESET_FILE
            
            echo "has-changeset=false" >> $GITHUB_OUTPUT
            echo "changeset-created=true" >> $GITHUB_OUTPUT
          else
            echo "No conventional commits found, skipping changeset generation"
            echo "has-changeset=false" >> $GITHUB_OUTPUT
            echo "changeset-created=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit changeset
        if: steps.generate.outputs.changeset-created == 'true'
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .changeset
          git commit -m "chore: add auto-generated changeset"
          if ! git push --no-verify; then
            echo "Failed to push changeset. Please check repository permissions and try again."
            exit 1
          fi

      - name: Comment on PR
        if: steps.generate.outputs.changeset-created == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ü§ñ **Auto-generated changeset created**\n\nA changeset has been automatically generated based on your conventional commits. When this PR is merged, the changesets workflow will create a "Version Packages" PR with the version bumps and changelog updates.`
            });
